# AF2-Multimer Automated Pipeline

[![Shell Script](https://img.shields.io/badge/Script-Bash-4EAA25?logo=gnu-bash\&logoColor=white)]()
[![AlphaFold2](https://img.shields.io/badge/AlphaFold2-Multimer-1f77b4)]()
[![ColabFold](https://img.shields.io/badge/ColabFold-AF2%20frontend-orange)]()
[![Greasy Scheduler](https://img.shields.io/badge/Greasy-Job%20Scheduler-9c27b0)]()

Automated workflow for **AlphaFold2-Multimer** predictions using **ColabFold**, followed by **GPU-based structural relaxation** managed through **Greasy**.
This script creates FASTA files, runs multiple AF2-Multimer model versions, generates relaxation tasks, and executes them in parallel.

---

## üìå Features

* Automatic FASTA generation (60 characters/line)
* Multimer sequence support (`:` chain separator)
* AF2-Multimer inference using *three* model versions (v1, v2, v3)
* GPU-based Amber relaxation
* Greasy-powered parallel job scheduling
* Environment-variable custom configuration

---

## üìÅ Workflow Summary

```
Input ‚Üí FASTA ‚Üí AF2-Multimer ‚Üí PDB Models ‚Üí Relaxation Jobs ‚Üí Relaxed Structures
```

---

# üîß Input Variables

The script uses three primary environment variables, each with a default value.
Override them before running the script if needed.

---

## **1. `CASE` ‚Äî Case Identifier**

**Purpose:**
Used to name folders, FASTA files, and output models.

**Default:**

```bash
4POU
```

**Override:**

```bash
export CASE="MyCaseID"
```

---

## **2. `SEQ` ‚Äî Protein or Multimer Sequence**

**Purpose:**
Full amino-acid sequence.
For complexes, separate chains with a colon `:`.

**Default example:**

```
SEQ1:SEQ2
```

**Override:**

```bash
export SEQ="AAAABBBBCCCC:DDDDFFFFGGG"
```

---

## **3. `GREASY` ‚Äî Path to Greasy Executable**

**Purpose:**
Specifies where the `greasy` binary is located.

**Default:**

```
/path/to/software/greasy/
```

**Override:**

```bash
export GREASY="/opt/greasy/bin"
```

---

# üìÇ Generated File Structure

After running the script, the following structure is created:

```
${CASE}/
‚îî‚îÄ‚îÄ AF2/
    ‚îî‚îÄ‚îÄ ${CASE}.fasta
```

The FASTA file contains:

* A header `>${CASE}`
* The sequence wrapped at 60 characters per line

---

# ü§ñ AlphaFold2-Multimer Execution

The script runs **colabfold_batch** for each of the following model versions:

* `alphafold2_multimer_v1`
* `alphafold2_multimer_v2`
* `alphafold2_multimer_v3`

All FASTA files located in `*/AF2/` are processed.

### Key options used

| Option             | Explanation                          |
| ------------------ | ------------------------------------ |
| `--save-recycles`  | Stores intermediate recycle states   |
| `--rank multimer`  | Ranking optimized for complexes      |
| `--use-dropout`    | Enables sampling for model diversity |
| `--num-recycle 20` | Uses 20 AF2 recycling iterations     |
| `--amber`          | Enables Amber relaxation             |
| `--use-gpu-relax`  | GPU-accelerated relaxation           |

Output files follow the pattern:

```
*.colabfold.v1
*.colabfold.v2
*.colabfold.v3
```

---

# üßò Relaxation Job List Generation

The script scans for predicted PDB structures matching:

```
*_*\.r*[0-9].pdb
```

For each file found, it generates a relaxation command:

```bash
colabfold_relax --max-iterations 2000 --tolerance 2.39 \
--stiffness 10.0 --max-outer-iterations 3 --use-gpu input.pdb output.pdb
```

These commands are saved to:

```
${CASE}.colabfold.relax.greasy
```

---

# ‚öôÔ∏è Parallel Execution with Greasy

Parallel GPU relaxation is managed by Greasy.

### Worker count:

```bash
export GREASY_NWORKERS=4
```

Modify to match the number of available GPUs:

```bash
export GREASY_NWORKERS=2
```

### Run Greasy:

```bash
$GREASY/greasy "${CASE}.colabfold.relax.greasy"
```

---

# üì¶ Requirements

* **ColabFold** (`colabfold_batch`, `colabfold_relax`)
* **Greasy** job scheduler
* **CUDA-capable GPU**
* GNU **bash** shell

---

# ‚ñ∂Ô∏è Usage Example

```bash
export CASE="MyComplex"
export SEQ="AAAAABBBB:CCCCDDDD"
export GREASY="/opt/greasy"
export GREASY_NWORKERS=2

bash run_af2_multimer.sh
```

---

# ‚ùó Troubleshooting

| Issue                     | Possible Cause                |
| ------------------------- | ----------------------------- |
| No GPU detected           | CUDA not installed or visible |
| Missing `colabfold_batch` | ColabFold not installed       |
| Greasy errors             | Incorrect `GREASY` path       |
| No PDB files found        | AF2 inference failed          |

---

